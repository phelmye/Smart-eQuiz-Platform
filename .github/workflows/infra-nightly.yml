name: Nightly infra smoke test

on:
  schedule:
    - cron: '0 3 * * *' # every day at 03:00 UTC
  workflow_dispatch: {}

jobs:
  nightly-smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Start docker-compose stack (postgres, redis, adminer)
        run: |
          docker compose -f dev/docker-compose.yml -f dev/docker-compose.ci.yml up -d postgres redis adminer

      - name: Wait for Postgres
        run: |
          CONTAINER=$(docker compose -f dev/docker-compose.yml -f dev/docker-compose.ci.yml ps -q postgres)
          echo "Postgres container: $CONTAINER"
          RETRY=0
          until docker exec -i $CONTAINER pg_isready -U postgres -d postgres >/dev/null 2>&1 || [ $RETRY -ge 60 ]; do
            echo "Waiting for postgres... ($RETRY)"
            sleep 2
            RETRY=$((RETRY+1))
          done
          if [ $RETRY -ge 60 ]; then
            docker logs $CONTAINER || true
            exit 1
          fi

      - name: Ensure target DB exists
        run: |
          CONTAINER=$(docker compose -f dev/docker-compose.yml -f dev/docker-compose.ci.yml ps -q postgres)
          EXISTS=$(docker exec -i $CONTAINER psql -U postgres -tAc "SELECT 1 FROM pg_database WHERE datname='smart_equiz_dev';")
          if [ "$EXISTS" != "1" ]; then
            docker exec -i $CONTAINER psql -U postgres -c "CREATE DATABASE smart_equiz_dev;"
          fi

      - name: Apply base schema
        run: |
          CONTAINER=$(docker compose -f dev/docker-compose.yml -f dev/docker-compose.ci.yml ps -q postgres)
          docker cp db/supabase_schema.sql $CONTAINER:/tmp/supabase_schema.sql
          docker exec -i $CONTAINER psql -U postgres -d smart_equiz_dev -f /tmp/supabase_schema.sql

      - name: Apply migrations (skip RLS)
        run: |
          CONTAINER=$(docker compose -f dev/docker-compose.yml -f dev/docker-compose.ci.yml ps -q postgres)
          for f in db/migrations/*.sql; do
            echo "Processing $f"
            base=$(basename "$f")
            case "$base" in
              *rls*) echo "Skipping RLS migration $base"; continue ;;
            esac
            docker cp "$f" "$CONTAINER":/tmp/"$base"
            docker exec -i $CONTAINER psql -U postgres -d smart_equiz_dev -f /tmp/"$base"
          done

      - name: Run local seeder
        run: node scripts/run-seed.mjs --local

      - name: Run Supabase verifier (optional)
        if: ${{ secrets.SUPABASE_SERVICE_ROLE != '' && secrets.SUPABASE_URL != '' }}
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
          EXPECT_TOURNAMENTS: '1'
          EXPECT_QUESTIONS: '2'
          EXPECT_TOURNAMENT_QUESTIONS: '2'
        run: |
          echo "Running Supabase verifier against $SUPABASE_URL"
          node scripts/verify-seed.mjs

      - name: Validate seeded counts (exact)
        run: |
          CONTAINER=$(docker compose -f dev/docker-compose.yml -f dev/docker-compose.ci.yml ps -q postgres)
          TOURS=$(docker exec -i $CONTAINER psql -U postgres -d smart_equiz_dev -t -A -c "SELECT count(*) FROM tournaments;")
          QUES=$(docker exec -i $CONTAINER psql -U postgres -d smart_equiz_dev -t -A -c "SELECT count(*) FROM questions;")
          MAPS=$(docker exec -i $CONTAINER psql -U postgres -d smart_equiz_dev -t -A -c "SELECT count(*) FROM tournament_questions;")
          echo "counts: tournaments=$TOURS questions=$QUES maps=$MAPS"
          # Expect exactly 1 tournament, 2 questions, and 2 tournament_questions from the local seeder
          if [ "${TOURS:-0}" -ne 1 ]; then echo "Expected exactly 1 tournament but found $TOURS" && exit 1; fi
          if [ "${QUES:-0}" -ne 2 ]; then echo "Expected exactly 2 questions but found $QUES" && exit 1; fi
          if [ "${MAPS:-0}" -ne 2 ]; then echo "Expected exactly 2 tournament_questions but found $MAPS" && exit 1; fi

      - name: Collect logs (on failure)
        if: failure()
        run: |
          echo "Collecting docker and postgres logs for debugging..."
          docker compose -f dev/docker-compose.yml -f dev/docker-compose.ci.yml logs postgres > infra-postgres-logs.txt || true
          docker compose -f dev/docker-compose.yml -f dev/docker-compose.ci.yml logs > infra-compose-logs.txt || true

      - name: Upload logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: infra-logs
          path: |
            infra-postgres-logs.txt
            infra-compose-logs.txt

      - name: Tear down
        if: always()
        run: docker compose -f dev/docker-compose.yml -f dev/docker-compose.ci.yml down -v
